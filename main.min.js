var e=document.getElementById("canvas");e.width=window.innerWidth,e.height=window.innerHeight;var r=e.getContext("webgl2"),t=(r.getExtension("EXT_color_buffer_half_float"),{vertex:"#version 300 es\n        precision highp float;in vec2 aPosition;out vec2 vPosition;void main(){vPosition = aPosition;gl_Position = vec4(aPosition, 0, 1);}\n    ",fragmentMain:`#version 300 es
precision highp float;layout(location=0) out vec4 pc_FragColor;uniform sampler2D heightTexture;uniform vec3 cameraPos,cameraDir;uniform vec2 resolution;uniform highp float time;in vec2 vPosition;mat4 f(vec3 e,vec3 v){vec3 f=normalize(v-e),y=normalize(cross(f,vec3(0,1,0)));return mat4(vec4(y,0),vec4(cross(y,f),0),vec4(-f,0),vec4(0,0,0,1));}vec3 p(vec2 e,vec2 v){return normalize(vec3(v-e/2.,-e.y/tan(radians(75.)/2.)));}float f(vec3 v,vec3 e,float m){bool f=false;if(v.y>25.&&e.y<0.)m=(v.y-25.)/-e.y;float y=.01,i=0.,r=0.,t=-1.,c=m;for(;c<1e3;){vec3 h=v+e*c;float x=25.*textureLod(heightTexture,(h.xz*.5+.5)*.01+vec2(.5),0.).x;if(h.y<x){t=c-y+y*(i-r)/(h.y-r-x+i);f=true;break;}y=max(.4*abs(h.y-x),.001);i=x;r=h.y;c+=y;}if(f)for(int x=0;x<8;x++){y*=.5;vec3 h=v+e*t;float w=25.*textureLod(heightTexture,(h.xz*.5+.5)*.01+vec2(.5),0.).x;if(h.y<w)t-=y;else t+=y;}return t;}float x(vec3 m,vec3 v){float f=1.,y=.01,x=0.;for(int i=0;i<80;i++){vec3 h=m+v*y;float e=h.y-25.*textureLod(heightTexture,(h.xz*.5+.5)*.01+vec2(.5),2.).x+.25;f=min(f,8.*e/y);if(e<0.)x+=y;if(f<1e-4||h.y>25.)break;y+=clamp(e,.5+y*.05,25.);}return clamp(f,0.,1.);}float f(vec3 v){float f=textureLod(heightTexture,.0025*v.xz-time*.01,0.).x;f*=f;f*=pow(1.-clamp(abs(v.y-25.)/10.,0.,1.),5.-4.*f);return f;}float p(vec2 v){return fract(sin(dot(v,vec2(12.9898,4.1414)))*43758.5453);}vec4 f(float e,vec3 v,vec3 m,vec3 f){vec3 h=m;if(h.y==0.)h.y=1e-4;float y=clamp(.1/.15*exp(-v.y*.15)*(1.-exp(-e*h.y*.15))/h.y,0.,1.);return vec4(mix(vec3(.5,.6,.7),vec3(1,.9,.7),clamp(pow(max(dot(m,f),0.),8.),0.,1.)),y);}vec3 f(vec3 v,vec3 h,vec3 e,float m,vec3 y){float x=0.,i=m,c=(h.y-15.)/-e.y,r=(h.y-35.)/-e.y,t=min(c,r),d=max(c,r);if(t>x)x=t;if(d<i)i=d;if(i>1e3)i=1e3;float w=0.,s=1.;vec3 b=vec3(0);float n=0.;for(float u=0.;u<32.;u++){float z=mix(x,i,(u+p(gl_FragCoord.xy))/32.);vec3 g=h+e*z;float a=f(g),C=f(g+y*.1);w+=a*(i-x)/32.;s-=.75*a*C*exp(-.5*w)*(i-x)/32.;vec4 o=f(z,h,e,y);float k=a*(i-x)/32.*exp(-.5*w);b+=mix(vec3(1),o.xyz,o.w)*k;n+=k;}if(n>0.)b/=n;else b=vec3(1);s=clamp(s,0.,1.);float o=clamp(1.-exp(-w*.5),0.,1.);return mix(v,b*s,o);}float x(vec3 v){vec3 e=vec3(0,1,0);float h=0.,y=50.,i=(v.y-15.)/-e.y,x=(v.y-35.)/-e.y,m=min(i,x),c=max(i,x);if(m>h)h=m;if(c<y)y=c;if(y>1e3)y=1e3;float r=0.;for(float t=0.;t<32.;t++){float w=mix(h,y,(t+p(gl_FragCoord.xy))/32.),a=f(v+e*w);r+=a*(y-h)/32.;}return clamp(1.-exp(-r*.5),0.,1.);}vec3 f(vec3 v,float e,vec3 h,vec3 m,vec3 y,bool x){vec3 t=m;if(t.y==0.)t.y=1e-4;vec3 i=mix(vec3(.5,.6,.7),vec3(1,.9,.7),clamp(pow(max(dot(m,y),0.),8.),0.,1.));if(x)return f(i,h,m,e,y);float r=clamp(.1/.15*exp(-h.y*.15)*(1.-exp(-e*t.y*.15))/t.y,0.,1.);v=mix(v,i,r);return f(v,h,m,e,y);}highp float p(sampler2D v,vec2 e,vec2 y,float f){return textureLod(v,e+y,f).x;}vec3 x(float v,float e,float h,float x){return normalize(vec3(-25.*(v-e),.001,-25.*(h-x)));}vec4 m(sampler2D v,vec2 e,float y,float f){float h=p(v,e,vec2(1./y,0),f),i=p(v,e,vec2(-1./y,0),f),m=p(v,e,vec2(0,1./y),f),x=p(v,e,vec2(0,-1./y),f);return vec4(h,i,m,x);}void main(){vec3 v=normalize(vec3(2,1,2)),e=p(resolution,gl_FragCoord.xy),y=cameraPos,h=y,i=(f(y,y+cameraDir)*vec4(e,1)).xyz;if(i.y==0.)i.y=1e-4;vec3 t=h;float c=f(h,i,1.),s=(h.y-10.)/-i.y;bool r=false;vec3 d;float w;vec3 u,b,z;if(s>0.&&s<c){w=c;u=h+i*w;b=h;z=i;h+=i*s;vec3 n=normalize(vec3(.025*(texture(heightTexture,.25*h.xz-.05*time).x*2.-1.),1,.025*(texture(heightTexture,.25*h.zx+.05*time).x*2.-1.)));d=n;i=reflect(i,n);c=f(h,i,.1);r=true;}vec3 n=vec3(0);if(c>0.){t=h+i*c;vec2 o=(t.xz*.5+.5)*.01+vec2(.5);float g=0.,a=2048.;vec4 k;for(int C=0;C<3;C++){k=m(heightTexture,o,a,g);if(k.x!=k.y||k.z!=k.w)break;g+=1.;a/=2.;}vec3 C=x(k.x,k.y,k.z,k.w);k=m(heightTexture,o,256.,3.);vec3 l=x(k.x,k.y,k.z,k.w);float B=t.y/25.,A=texture(heightTexture,.1*t.yz).x*2.-1.,D=texture(heightTexture,.1*t.zx).x*2.-1.,E=texture(heightTexture,.1*t.xy).x*2.-1.;vec3 F=abs(C);F/=F.x+F.y+F.z;float G=.1*(F.x*A+F.y*D+F.z*E);vec3 H=mix(vec3(0,.75,0),vec3(.85,.5,0),smoothstep(0.,1.,clamp(1.-pow(l.y,.15)+G,0.,1.)));H=mix(vec3(.95,.85,.7),H,smoothstep(.4,.5,B+G));H=mix(H,vec3(.9),smoothstep(.7,.75,B+G));H*=1.+2.*G;float I=max(dot(C,v),0.),J=x(t+v*.02,v);I*=J;float K=1.-x(t),L=1.;for(float M=4.;M<=8.;M++)L*=clamp(1.-10./pow(2.,M-4.)*max(textureLod(heightTexture,o,M).x-B,0.),0.,1.);vec3 M=vec3(.425,.25,.25),N=vec3(0);N=C.y<0.?mix(vec3(0,0,.5),M,1.+C.y):mix(M,vec3(0,.7,1),C.y);n=(H*.3*sqrt(L)+H*I*L+N*H*L/3.14159)*(.25+.75*K);n=f(n,c,h,i,v,false);}else n=f(vec3(1),1e5,h,i,v,true);if(r){n=mix(n,.8*vec3(0,.9*exp(-.35*clamp(distance(u,h),0.,1.)),1),max(dot(-z,vec3(0,1,0)),0.));n*=.75+.25*max(dot(d,v),0.);if(c<=0.){float k=pow(max(dot(i,v),0.),64.);n+=vec3(1)*k;}float k=1./pow(10.-u.y+1.,15.)*min(20.*(10.-u.y),1.);if(k>1./255.)n=mix(n,vec3(.75),(.5+.5*sin((20.+.1*(2.*textureLod(heightTexture,.01*h.xz-.001*time,0.).x-1.))*u.y-5.*time+20.*(2.*textureLod(heightTexture,.01*h.zx+.001*time,0.).x-1.)))*k);n=f(n,s,b,z,v,false);}pc_FragColor=vec4(n,1);}`,fragmentHeightMap:`#version 300 es
precision highp float;layout(location=0) out vec4 pc_FragColor;in vec2 vPosition;vec3 v(vec3 v){return mod((v*34.+1.)*v,289.);}float t(vec2 m){const vec4 n=vec4(.211324865405187,.366025403784439,-.577350269189626,.024390243902439);vec2 x=floor(m+dot(m,n.yy)),y=m-x+dot(x,n.xx),r;r=y.x>y.y?vec2(1,0):vec2(0,1);vec4 d=y.xyxy+n.xxzz;d.xy-=r;x=mod(x,289.);vec3 z=v(v(x.y+vec3(0,r.y,1))+x.x+vec3(0,r.x,1)),a=max(.5-vec3(dot(y,y),dot(d.xy,d.xy),dot(d.zw,d.zw)),0.);a*=a;a*=a;vec3 f=2.*fract(z*n.www)-1.,p=abs(f)-.5,c=f-floor(f+.5);a*=1.79284291400159-.85373472095314*(c*c+p*p);vec3 w;w.x=c.x*y.x+p.x*y.y;w.yz=c.yz*d.xz+p.yz*d.yw;return 130.*dot(a,w);}
#define NUM_OCTAVES 8
float m(vec2 v){float x=0.,m=.5;vec2 p=vec2(100);mat2 a=mat2(cos(.5),sin(.5),-sin(.5),cos(.5));for(int y=0;y<NUM_OCTAVES;++y)x+=m*t(v),v=a*v*2.+p,m*=.5;return x;}void main(){float v=m(vPosition*2.5),x=m(vec2(-vPosition.x,vPosition.y)*2.5),d=m(vec2(vPosition.x,-vPosition.y)*2.5),y=m(vec2(-vPosition.x,-vPosition.y)*2.5),r=.5*pow(abs(vPosition.x),10.);pc_FragColor=vec4(vec3(.5+.5*mix(mix(v,x,r),mix(d,y,r),.5*pow(abs(vPosition.y),10.))),1);}`}),a={vertex:h(r,35633,t.vertex),fragmentMain:h(r,35632,t.fragmentMain),fragmentHeightMap:h(r,35632,t.fragmentHeightMap)},n={main:d(r,a.vertex,a.fragmentMain),heightMap:d(r,a.vertex,a.fragmentHeightMap)},i=function(e,r){var t=e.createBuffer();return e.bindBuffer(34962,t),e.bufferData(34962,new Float32Array(r),35044),t}(r,[-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),o=function(e,r,t,a,n,i=r){var o=e.createTexture();e.bindTexture(3553,o),0!=e.getError()&&console.error("Error binding texture");e.texImage2D(3553,0,i,t,a,0,r,n,null),0!=e.getError()&&console.error("Error setting texture image");return e.texParameteri(3553,10241,9987),e.texParameteri(3553,10240,9729),e.texParameteri(3553,10242,10497),e.texParameteri(3553,10243,10497),o}(r,6403,2048,2048,5121,33321),m=function(e,r){var t=e.createFramebuffer();return e.bindFramebuffer(36160,t),e.framebufferTexture2D(36160,36064,3553,r,0),e.texParameteri(3553,10241,9729),t}(r,o);r.clearColor(0,0,0,0),function(e,r,t,a,n){e.bindFramebuffer(36160,t),e.viewport(0,0,n[0],n[1]),s(e,r,a)}(r,n.heightMap,m,i,[2048,2048]),r.bindTexture(3553,o),r.texParameteri(3553,10241,9987),r.texParameteri(3553,10240,9729),r.generateMipmap(3553);const f={};document.addEventListener("keydown",(e=>{f[e.key]=!0})),document.addEventListener("keyup",(e=>{f[e.key]=!1})),document.addEventListener("click",(r=>{e.requestPointerLock()})),document.addEventListener("mousemove",(r=>{document.pointerLockElement===e&&(u+=.001*r.movementX,g-=.001*r.movementY,g=Math.max(Math.min(g,Math.PI/2),-Math.PI/2))}));let c=[0,20,0],u=0,g=0;function h(e,r,t){var a=e.createShader(r);return e.shaderSource(a,t),e.compileShader(a),e.getShaderParameter(a,35713)||console.error("Shader failed to compile: "+e.getShaderInfoLog(a)),a}function d(e,r,t){var a=e.createProgram();return e.attachShader(a,r),e.attachShader(a,t),e.linkProgram(a),e.getProgramParameter(a,35714)||console.error("Program failed to link: "+e.getProgramInfoLog(a)),a}function s(e,r,t){e.useProgram(r),e.enableVertexAttribArray(0),e.bindBuffer(34962,t),e.vertexAttribPointer(0,2,5126,!1,0,0),e.drawArrays(4,0,6)}!function t(){let a=[0,0,0];a[0]=Math.cos(u)*Math.cos(g),a[1]=Math.sin(g),a[2]=Math.sin(u)*Math.cos(g);const m=a,h=[Math.cos(u+Math.PI/2)*Math.cos(g),Math.sin(g),Math.sin(u+Math.PI/2)*Math.cos(g)];f.w&&(c[0]+=m[0],c[1]+=m[1],c[2]+=m[2]),f.s&&(c[0]-=m[0],c[1]-=m[1],c[2]-=m[2]),f.a&&(c[0]-=h[0],c[1]-=h[1],c[2]-=h[2]),f.d&&(c[0]+=h[0],c[1]+=h[1],c[2]+=h[2]),r.useProgram(n.main);var d=r.getUniformLocation(n.main,"heightTexture"),v=r.getUniformLocation(n.main,"time"),l=r.getUniformLocation(n.main,"cameraPos"),P=r.getUniformLocation(n.main,"cameraDir");r.uniform1i(d,0),r.uniform3fv(l,c),r.uniform3fv(P,a);const x=[e.width,e.height];r.uniform2fv(r.getUniformLocation(n.main,"resolution"),x),r.activeTexture(33984),r.bindTexture(3553,o),r.uniform1f(v,performance.now()/1e3),function(e,r,t){e.bindFramebuffer(36160,null),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),s(e,r,t)}(r,n.main,i),requestAnimationFrame(t)}();