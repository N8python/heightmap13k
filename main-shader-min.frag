#version 300 es
precision highp float;layout(location=0) out vec4 pc_FragColor;uniform sampler2D heightTexture;uniform vec3 cameraPos,cameraDir;uniform vec2 resolution;uniform highp float time;in vec2 vPosition;mat4 f(vec3 e,vec3 v){vec3 f=normalize(v-e),y=normalize(cross(f,vec3(0,1,0)));return mat4(vec4(y,0),vec4(cross(y,f),0),vec4(-f,0),vec4(0,0,0,1));}vec3 p(vec2 e,vec2 v){return normalize(vec3(v-e/2.,-e.y/tan(radians(75.)/2.)));}float f(vec3 v,vec3 e,float m){bool f=false;if(v.y>25.&&e.y<0.)m=(v.y-25.)/-e.y;float y=.01,i=0.,r=0.,t=-1.,c=m;for(;c<1e3;){vec3 h=v+e*c;float x=25.*textureLod(heightTexture,(h.xz*.5+.5)*.01+vec2(.5),0.).x;if(h.y<x){t=c-y+y*(i-r)/(h.y-r-x+i);f=true;break;}y=max(.4*abs(h.y-x),.001);i=x;r=h.y;c+=y;}if(f)for(int x=0;x<8;x++){y*=.5;vec3 h=v+e*t;float w=25.*textureLod(heightTexture,(h.xz*.5+.5)*.01+vec2(.5),0.).x;if(h.y<w)t-=y;else t+=y;}return t;}float x(vec3 m,vec3 v){float f=1.,y=.01,x=0.;for(int i=0;i<80;i++){vec3 h=m+v*y;float e=h.y-25.*textureLod(heightTexture,(h.xz*.5+.5)*.01+vec2(.5),2.).x+.25;f=min(f,8.*e/y);if(e<0.)x+=y;if(f<1e-4||h.y>25.)break;y+=clamp(e,.5+y*.05,25.);}return clamp(f,0.,1.);}float f(vec3 v){float f=textureLod(heightTexture,.0025*v.xz-time*.01,0.).x;f*=f;f*=pow(1.-clamp(abs(v.y-25.)/10.,0.,1.),5.-4.*f);return f;}float p(vec2 v){return fract(sin(dot(v,vec2(12.9898,4.1414)))*43758.5453);}vec4 f(float e,vec3 v,vec3 m,vec3 f){vec3 h=m;if(h.y==0.)h.y=1e-4;float y=clamp(.1/.15*exp(-v.y*.15)*(1.-exp(-e*h.y*.15))/h.y,0.,1.);return vec4(mix(vec3(.5,.6,.7),vec3(1,.9,.7),clamp(pow(max(dot(m,f),0.),8.),0.,1.)),y);}vec3 f(vec3 v,vec3 h,vec3 e,float m,vec3 y){float x=0.,i=m,c=(h.y-15.)/-e.y,r=(h.y-35.)/-e.y,t=min(c,r),d=max(c,r);if(t>x)x=t;if(d<i)i=d;if(i>1e3)i=1e3;float w=0.,s=1.;vec3 b=vec3(0);float n=0.;for(float u=0.;u<32.;u++){float z=mix(x,i,(u+p(gl_FragCoord.xy))/32.);vec3 g=h+e*z;float a=f(g),C=f(g+y*.1);w+=a*(i-x)/32.;s-=.75*a*C*exp(-.5*w)*(i-x)/32.;vec4 o=f(z,h,e,y);float k=a*(i-x)/32.*exp(-.5*w);b+=mix(vec3(1),o.xyz,o.w)*k;n+=k;}if(n>0.)b/=n;else b=vec3(1);s=clamp(s,0.,1.);float o=clamp(1.-exp(-w*.5),0.,1.);return mix(v,b*s,o);}float x(vec3 v){vec3 e=vec3(0,1,0);float h=0.,y=50.,i=(v.y-15.)/-e.y,x=(v.y-35.)/-e.y,m=min(i,x),c=max(i,x);if(m>h)h=m;if(c<y)y=c;if(y>1e3)y=1e3;float r=0.;for(float t=0.;t<32.;t++){float w=mix(h,y,(t+p(gl_FragCoord.xy))/32.),a=f(v+e*w);r+=a*(y-h)/32.;}return clamp(1.-exp(-r*.5),0.,1.);}vec3 f(vec3 v,float e,vec3 h,vec3 m,vec3 y,bool x){vec3 t=m;if(t.y==0.)t.y=1e-4;vec3 i=mix(vec3(.5,.6,.7),vec3(1,.9,.7),clamp(pow(max(dot(m,y),0.),8.),0.,1.));if(x)return f(i,h,m,e,y);float r=clamp(.1/.15*exp(-h.y*.15)*(1.-exp(-e*t.y*.15))/t.y,0.,1.);v=mix(v,i,r);return f(v,h,m,e,y);}highp float p(sampler2D v,vec2 e,vec2 y,float f){return textureLod(v,e+y,f).x;}vec3 x(float v,float e,float h,float x){return normalize(vec3(-25.*(v-e),.001,-25.*(h-x)));}vec4 m(sampler2D v,vec2 e,float y,float f){float h=p(v,e,vec2(1./y,0),f),i=p(v,e,vec2(-1./y,0),f),m=p(v,e,vec2(0,1./y),f),x=p(v,e,vec2(0,-1./y),f);return vec4(h,i,m,x);}void main(){vec3 v=normalize(vec3(2,1,2)),e=p(resolution,gl_FragCoord.xy),y=cameraPos,h=y,i=(f(y,y+cameraDir)*vec4(e,1)).xyz;if(i.y==0.)i.y=1e-4;vec3 t=h;float c=f(h,i,1.),s=(h.y-10.)/-i.y;bool r=false;vec3 d;float w;vec3 u,b,z;if(s>0.&&s<c){w=c;u=h+i*w;b=h;z=i;h+=i*s;vec3 n=normalize(vec3(.025*(texture(heightTexture,.25*h.xz-.05*time).x*2.-1.),1,.025*(texture(heightTexture,.25*h.zx+.05*time).x*2.-1.)));d=n;i=reflect(i,n);c=f(h,i,.1);r=true;}vec3 n=vec3(0);if(c>0.){t=h+i*c;vec2 o=(t.xz*.5+.5)*.01+vec2(.5);float g=0.,a=2048.;vec4 k;for(int C=0;C<3;C++){k=m(heightTexture,o,a,g);if(k.x!=k.y||k.z!=k.w)break;g+=1.;a/=2.;}vec3 C=x(k.x,k.y,k.z,k.w);k=m(heightTexture,o,256.,3.);vec3 l=x(k.x,k.y,k.z,k.w);float B=t.y/25.,A=texture(heightTexture,.1*t.yz).x*2.-1.,D=texture(heightTexture,.1*t.zx).x*2.-1.,E=texture(heightTexture,.1*t.xy).x*2.-1.;vec3 F=abs(C);F/=F.x+F.y+F.z;float G=.1*(F.x*A+F.y*D+F.z*E);vec3 H=mix(vec3(0,.75,0),vec3(.85,.5,0),smoothstep(0.,1.,clamp(1.-pow(l.y,.15)+G,0.,1.)));H=mix(vec3(.95,.85,.7),H,smoothstep(.4,.5,B+G));H=mix(H,vec3(.9),smoothstep(.7,.75,B+G));H*=1.+2.*G;float I=max(dot(C,v),0.),J=x(t+v*.02,v);I*=J;float K=1.-x(t),L=1.;for(float M=4.;M<=8.;M++)L*=clamp(1.-10./pow(2.,M-4.)*max(textureLod(heightTexture,o,M).x-B,0.),0.,1.);vec3 M=vec3(.425,.25,.25),N=vec3(0);N=C.y<0.?mix(vec3(0,0,.5),M,1.+C.y):mix(M,vec3(0,.7,1),C.y);n=(H*.3*sqrt(L)+H*I*L+N*H*L/3.14159)*(.25+.75*K);n=f(n,c,h,i,v,false);}else n=f(vec3(1),1e5,h,i,v,true);if(r){n=mix(n,.8*vec3(0,.9*exp(-.35*clamp(distance(u,h),0.,1.)),1),max(dot(-z,vec3(0,1,0)),0.));n*=.75+.25*max(dot(d,v),0.);if(c<=0.){float k=pow(max(dot(i,v),0.),64.);n+=vec3(1)*k;}float k=1./pow(10.-u.y+1.,15.)*min(20.*(10.-u.y),1.);if(k>1./255.)n=mix(n,vec3(.75),(.5+.5*sin((20.+.1*(2.*textureLod(heightTexture,.01*h.xz-.001*time,0.).x-1.))*u.y-5.*time+20.*(2.*textureLod(heightTexture,.01*h.zx+.001*time,0.).x-1.)))*k);n=f(n,s,b,z,v,false);}pc_FragColor=vec4(n,1);}