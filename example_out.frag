#define normalize n
#version 300 es
precision highp float;layout(location=0)out vec4 pc_FragColor;uniform lowp sampler2D colorTexture,heightTexture;uniform vec3 cameraPos,cameraDir;uniform float time;in vec2 vPosition;mat4 i(vec3 t,vec3 o,vec3 c){vec3 i=n(o-t),v=n(cross(i,c)),a=cross(v,i);return mat4(vec4(v,0.),vec4(a,0.),vec4(-i,0.),vec4(0,0,0,1));}vec3 i(float v,vec2 i,vec2 t){vec2 o=t-i/2.;float c=i.y/tan((v)/2.);return n(vec3(o,-c));}vec4 i(vec4 i){return mod((i*34.+1.)*i,289.);}vec4 v(vec4 i){return 1.7928429-.85373473*i;}float v(vec3 h){vec3 o=floor(h+dot(h,vec3(.33333334))),t=h-o+dot(o,vec3(.16666667)),d=step(t.yzx,t),T=1.-d,f=min(d,T.zxy),u=max(d,T.zxy),n=t-f+vec3(.16666667),z=t-u+vec3(.33333334),p=t-1.+vec3(.5);o=mod(o,289.);vec4 w=i(i(i(o.z+vec4(0.,f.z,u.z,1.))+o.y+vec4(0.,f.y,u.y,1.))+o.x+vec4(0.,f.x,u.x,1.));float q=.14285715;vec3 c=q*vec3(2,.5,1)-vec3(0,1,0);vec4 L=w-49.*floor(w*c.z*c.z),b=floor(L*c.z),j=floor(L-7.*b),g=b*c.x+c.yyyy,s=j*c.x+c.yyyy,a=1.-abs(g)-abs(s),C=vec4(g.xy,s.xy),F=vec4(g.zw,s.zw),A=floor(C)*2.+1.,B=floor(F)*2.+1.,D=-step(a,vec4(0)),P=C.xzyw+A.xzyw*D.xxyy,k=F.xzyw+B.xzyw*D.zzww;vec3 e=vec3(P.xy,a.x),l=vec3(P.zw,a.y),r=vec3(k.xy,a.z),y=vec3(k.zw,a.w);vec4 m=v(vec4(dot(e,e),dot(l,l),dot(r,r),dot(y,y)));e*=m.x,l*=m.y,r*=m.z,y*=m.w;vec4 x=max(.6-vec4(dot(t,t),dot(n,n),dot(z,z),dot(p,p)),0.);return x=x*x,42.*dot(x*x,vec4(dot(e,t),dot(l,n),dot(r,z),dot(y,p)));}float i(vec3 i){float t,o=.5;vec3 c=vec3(1e2);for(int a;a<8;++a)t+=o*v(i),i=i*2.+c,o*=.75;return t;}float i(vec3 t,vec3 o,float c,float u){bool e;if(t.y>c&&o.y<0.)u=(t.y-c)/-o.y;float l=1e3,i=.01,x,f,v=-1.,a=u;for(;a<l;){vec3 u=t+o*a;float r=c*textureLod(heightTexture,(u.xz*.5+.5)*.01+vec2(.5),0.).x;if(u.y<r){v=a-i+i*(x-f)/(u.y-f-r+x),e=true;break;}i=max(.4*abs(u.y-r),.001),x=r,f=u.y,a+=i;}if(e)for(int a;a<8;a++){i*=.5;vec3 x=t+o*v;float f=c*textureLod(heightTexture,(x.xz*.5+.5)*.01+vec2(.5),0.).x;x.y<f?v-=i:v+=i;}return v;}float v(vec3 o,vec3 c,float t,float a){float v=1.,i=a,x;for(int u;u<80;u++){vec3 a=o+c*i;float e=t*textureLod(heightTexture,(a.xz*.5+.5)*.01+vec2(.5),2.).x,f=a.y-e+.25;if(v=min(v,8.*f/i),f<0.)x+=i;if(v<1e-4||a.y>t)break;i+=clamp(f,.5+i*.05,25.);}return clamp(v,0.,1.);}float i(vec3 v,float t,float o){float i=textureLod(heightTexture,.0025*v.xz-time*.01,0.).x;return i=i*i,i*=pow(1.-clamp(abs(v.y-t)/o,0.,1.),5.-4.*i);}float i(vec2 i){return fract(sin(dot(i,vec2(12.9898,4.1414)))*43758.547);}vec4 i(float o,vec3 c,vec3 t,vec3 a){vec3 i=t;if(i.y==0.)i.y=1e-4;float x=.1,v=.15,f=max(dot(t,a),0.);vec3 u=mix(vec3(.5,.6,.7),vec3(1,.9,.7),clamp(pow(f,8.),0.,1.));float e=clamp(x/v*exp(-c.y*v)*(1.-exp(-o*i.y*v))/i.y,0.,1.);vec4 l=vec4(u,e);return l;}vec3 i(vec3 r,vec3 c,vec3 a,float g,vec3 m,bool s){float x=25.,f=10.,t,v=g,h=(c.y-x-f)/-a.y,d=(c.y-(x+f))/-a.y,n=min(h,d),z=max(h,d);if(n>t)t=n;if(z<v)v=z;if(v>1e3)v=1e3;float u,e=1.,o=32.;vec3 l;float y;for(float r;r<o;r++){float d=mix(t,v,(r+i(gl_FragCoord.xy))/o);vec3 n=c+a*d;float h=i(n,x,f),g=i(n+m*.1,x,f);u+=h*(v-t)/o,e-=.75*h*g*exp(-.5*u)*(v-t)/o;vec4 z=i(d,c,a,m);float p=h*(v-t)/o*exp(-.5*u);l+=mix(vec3(1),z.xyz,z.w)*p,y+=p;}y>0.?l/=y:l=vec3(1),e=clamp(e,0.,1.);float p=clamp(1.-exp(-u*.5),0.,1.);if(s)return vec3(p);return r=mix(r,l*e,p),r;}float i(float m,vec3 o,vec3 c){float a=25.,x=10.,t,v=m,u=(o.y-a-x)/-c.y,e=(o.y-(a+x))/-c.y,l=min(u,e),r=max(u,e);if(l>t)t=l;if(r<v)v=r;if(v>1e3)v=1e3;float y,f=32.;for(float u;u<f;u++){float e=mix(t,v,(u+i(gl_FragCoord.xy))/f);vec3 l=o+c*e;float r=i(l,a,x);y+=r*(v-t)/f;}float h=clamp(1.-exp(-y*.5),0.,1.);return h;}vec3 i(vec3 v,float a,vec3 x,vec3 t,vec3 f,bool e){vec3 o=t;if(o.y==0.)o.y=1e-4;float l=.1,u=.15,r=max(dot(t,f),0.);vec3 c=mix(vec3(.5,.6,.7),vec3(1,.9,.7),clamp(pow(r,8.),0.,1.));if(e)return c=i(c,x,t,a,f,false),c;float y=clamp(l/u*exp(-x.y*u)*(1.-exp(-a*o.y*u))/o.y,0.,1.);return v=mix(v,c,y),v=i(v,x,t,a,f,false);}vec3 v(vec3 v,vec3 t,vec3 o){vec3 c=i(vec3(1),1e5,v,t,o,true);return c;}void main(){vec3 a=vec3(.6666667,.33333334,.6666667);vec2 z=vec2(2048);vec3 p=i(75.,z,gl_FragCoord.xy);float x=25.;vec3 r=cameraPos,g=r+cameraDir,s=vec3(0,1,0),t=r,o=(i(r,g,s)*vec4(p,1.)).xyz;if(o.y==0.)o.y=1e-4;vec3 f=t;float u=i(t,o,x,1.),l=(t.y-10.)/-o.y;bool h;vec3 y;float d;vec3 e,n,m;if(l>0.&&l<u){d=u,e=t+o*d,n=t,m=o,t+=o*l;float v=.025;vec3 c=n(vec3(v*(texture(heightTexture,.25*t.xz-.05*time).x*2.-1.),1.,v*(texture(heightTexture,.25*t.zx+.05*time).x*2.-1.)));y=c,o=reflect(o,c),u=i(t,o,x,.1),h=true;}vec3 c;if(u>0.){f=t+o*u;vec2 e=(f.xz*.5+.5)*.01+vec2(.5);float y=textureLod(heightTexture,e+vec2(.00048828,0),0.).x,m=textureLod(heightTexture,e-vec2(.00048828,0),0.).x,h=textureLod(heightTexture,e+vec2(0,.00048828),0.).x,d=textureLod(heightTexture,e-vec2(0,.00048828),0.).x;if(y==m&&h==d)y=textureLod(heightTexture,e+vec2(.00097656,0),1.).x,m=textureLod(heightTexture,e-vec2(.00097656,0),1.).x,h=textureLod(heightTexture,e+vec2(0,.00097656),1.).x,d=textureLod(heightTexture,e-vec2(0,.00097656),1.).x;if(y==m&&h==d)y=textureLod(heightTexture,e+vec2(.00195312,0),2.).x,m=textureLod(heightTexture,e-vec2(.00195312,0),2.).x,h=textureLod(heightTexture,e+vec2(0,.00195312),2.).x,d=textureLod(heightTexture,e-vec2(0,.00195312),2.).x;vec3 n=n(vec3(-x*(y-m),.001,-x*(h-d)));y=textureLod(heightTexture,e+vec2(.00390625,0),3.).x,m=textureLod(heightTexture,e-vec2(.00390625,0),3.).x,h=textureLod(heightTexture,e+vec2(0,.00390625),3.).x,d=textureLod(heightTexture,e-vec2(0,.00390625),3.).x;vec3 L=n(vec3(-x*(y-m),.001,-x*(h-d)));float g=f.y/x,b=texture(heightTexture,.1*f.yz).x*2.-1.,C=texture(heightTexture,.1*f.zx).x*2.-1.,F=texture(heightTexture,.1*f.xy).x*2.-1.;vec3 l=abs(n);l=l/(l.x+l.y+l.z);float z=.1*(l.x*b+l.y*C+l.z*F);vec3 r=mix(vec3(0,.75,0),vec3(.85,.5,0),smoothstep(0.,1.,clamp(1.-pow(L.y,.15)+z,0.,1.)));r=mix(vec3(.95,.85,.7),r,smoothstep(.4,.5,g+z)),r=mix(r,vec3(.9),smoothstep(.7,.75,g+z)),r*=1.+2.*z;float s=max(dot(n,a),0.);vec3 D=a;float P=v(f+a*.02,D,x,.01);s*=P;float k=1.-i(50.,f,vec3(0,1,0)),q=.3,p=1.;for(float i=4.;i<=8.;i++)p*=clamp(1.-10./pow(2.,i-4.)*max(textureLod(heightTexture,e,i).x-g,0.),0.,1.);vec3 j=vec3(0,0,.5),T=vec3(.425,.25,.25),A=vec3(0,.7,1),w;w=n.y<0.?mix(j,T,1.+n.y):mix(T,A,n.y),c=(r*q*sqrt(p)+r*s*p+w*r*p/3.14159)*(.25+.75*k),c=i(c,u,t,o,a,false);}else c=v(t,o,a);if(h){if(c=mix(c,vec3(0.,exp(-.5*clamp(distance(e,t),0.,1.)),1.),0.*pow(max(dot(-m,y),0.),1.)),c*=max(dot(y,a),0.),u<=0.){float i=pow(max(dot(o,a),0.),64.);c+=vec3(1)*i;}float v=1./pow(1.+(10.-e.y),15.)*min(20.*(10.-e.y),1.);if(v>.00392157)c=mix(c,vec3(.75),(.5+.5*sin((20.+.1*i(vec3(.01*t.xz,.001*time)))*e.y-5.*time+20.*i(vec3(.01*t.xz,.001*time))))*v);c=i(c,l,n,m,a,false);}pc_FragColor=vec4(c,1.);}